# 第五章 智慧居家WEB API的建立

## 5-1 智慧居家系統概述
智慧居家系統是一個大家已經講了很多年，但卻一直沒有普及的系統，雖然智慧居家每年都以一定的速度進行擴張，但作為一個全世界都矚目的技術，卻無法達到所預期的效果和普及程度，智慧居家遲遲無法得到爆發式的成長，主要歸咎於下面幾點:
1. 對於系統安全性的不信任
2. 智慧居家的規範沒有統一
3. 對於智慧居家的接受度不夠高
4. 價格相對高昂

其中最大的根本問題莫過於**智慧居家的規範沒有統一**，在沒有一個統一規範之前，這些智慧居家商品只能跟一些大廠商合作，才有機會嶄露頭角，但若有一個通用的通訊規範，就能讓獨立廠商也能推出屬於自己的智慧居家產品，以後我們便能透過購物網站上看到琳瑯滿目的智慧居家產品在市場上，而不是總是那幾家大企業所販賣的商品，而且智慧居家商品的價格也會有顯著的降低，當然已經有類似的組織在籌備類似的事情了，如亞馬遜、蘋果、谷歌、ZigBee聯盟所發起的**Matter**便是一個活生生的例子，這個規範預計在2022年推出，想必不需要幾年，每個人都能享受智慧居家所帶來的便利，讓智慧融入於我們生活中的每一個環節。
## 5-2 架構第一個WEB API
有了一個能夠儲存資料的資料庫後，便能開始正式建立第一個WEB API。

第一步需要先認識**HTTP**，HTTP這個詞在我們的生活中多少都有耳聞，像是網址前方便會有一個http:// HTTP(超文本傳輸協定)是一種協定，HTTP的主要功能便是讓伺服器與客路端溝通的橋樑，就像是你今天去youtube看影片，你便會發送**要求(requset)**，youtube伺服器透過你的資料**回應(response)** 你可能會想要觀看的影片HTTP中，會有很多種method做為請求的方法， 最常用的幾個動作分別為：GET/POST/PUT/DELET剛好對應著資料庫中的增刪查改，HTTP協議對現代人類史來說是必不可少的一環，沒有HTTP協議，便沒有現今這麼方便的網路可以使用了。

第二步便是要認識**RESTful API**，我們已經知道API的概念了，那RESTful又是什麼呢?REST指的是Representational State Transfer(表現層狀態轉移)，REST是一種設計風格，RESTful API便是指符合這種規範的API架構，這種規範就好比你去旅遊公司，你可以跟櫃台人員進行**報名行程**，**取消參加行程**，**查看參加行程**跟**修改行程相關資料**等，這些動作都可以由同一位櫃台人員完成，如果是一般的API每一項要求都必須有一個專門的人員負責，這便是**RESTful API**的基礎概念。

**RESTful API**是由以下三種元件所組成的:
1. Nouns：定義API的URL位置，例如google的URL便是 www.google.com 點進這個網址並不會導向其他的網站，就跟每個人家裡的地址一樣。
2. Verbs：對API做的動作。
3. Content Types：API 回傳的形式並不只一種，常見的有 JSON/XML 等，本書的範例皆使用JSON因為JSON比較好進行處理。

並不是所有WEB API的建立都會去參照RESTful API的規範，如果沒有使用此規範所建立的WEB API就會跟下面所範例的一樣。

```bash=
// 一般的 WEB API

GET    /GetData
POST   /createData
DELETE /Delete_Data/1
```
上述的例子，其命名規則並沒有得到很好的統一，因為一間公司的程式開發者並非只有一個，每個仁所習慣的命名規則皆不同，且每個功能都是對資料進行操作，但卻需要透過不同的接口才能對同一筆資料進行操作，加上命名的不確定性，讓使用者必須頻繁的翻閱API的使用說明書，這樣對於API的使用者並不是太友善，若是以 RESTful API 風格開發的話，整體的統一性將得到巨幅的提升。
```bash=
// RESTful API

GET     /data
POST    /data
DELETE  /data/1
```
其實現方式便是透過同一個URL，但是將其動作藏在 HTTP 的 method 裡面，所以使用 RESTful 風格設計的 API，比起一般的API多出了許多的優點。


## 5-3 WEB API的設計與建立
WEB API最重要的便是回傳的形式，透過先行規範JSON的構造，可以讓編寫WEB API的過程中有一個明確的目標，對於WEB API，我們把重點放在其中的Home/Area/Device/User這四個資料表，因為這四個資料表是使用者可以進行增刪查改的，下面為每個功能所回傳的JSON，以及其程式碼實作方式。





## 5-4 資安上面的疑慮
本章我們成功建立了一個關於智慧居家的WEB API模型，WEB API在資安上面是存在著許多漏洞的，在本書的範例中也存在的許多的資安漏洞，但因為本書的主題是如何建立，而並非對資安方面進行強化，但是只要建立好可將這套系統輕鬆套用在任何您所建立的WEB API中，對於整體WEB API的建構不會有任何的影響，至於要怎麼讓我們的API可以安全的進行資料交換呢?要達成這個目的必須建構出一套加密系統，例如只能使用Token，鎖IP或特定地區的VPN才能進行呼叫API的動作，基本上這些資源可以在許多地方找到，在整個API正式上架前，必須對資安進行強化，尤其是這個API會牽扯到金錢的流動，以免這個API成為整個系統的破口。